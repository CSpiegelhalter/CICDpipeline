env:
  IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/todo-api
  TAG: latest

steps:
  - uses: actions/checkout@v3

  - name: Log in to GHCR
    run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

  - name: Build Docker image
    run: docker build -t $IMAGE_NAME:$TAG .

  - name: Push Docker image
    run: docker push $IMAGE_NAME:$TAG

  - name: Update deployment.yaml
    run: |
      git config --global user.name "GitHub Actions"
      git config --global user.email "actions@github.com"

      git clone https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/CSpiegelhalter/CICDpipeline.git
      cd CICDpipeline/k8s-manifest

      sed -i "s|image: .*|image: $IMAGE_NAME:$TAG|" deployment.yaml
      git add deployment.yaml
      if git diff --cached --quiet; then
        echo "No changes to commit"
      else
        git commit -m "Update image to $TAG"
        git push
      fi
